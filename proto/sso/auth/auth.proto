syntax = "proto3";

package sso.auth.v1;

option go_package = "Salivare-DevHub/sso.auth.v1;authv1";

import "google/api/annotations.proto";
import "protoc-gen-openapiv2/options/annotations.proto";

option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_swagger) = {
  info: {
    title: "SSO Auth API";
    version: "1.0";
    description: "OAuth2 авторизация, обмен кодов, обновление токенов, получение профиля.";
  };

  schemes: HTTPS;
  consumes: "application/json";
  produces: "application/json";

  // Security схема для Authorization: Bearer <token>
  security_definitions: {
    security: {
      key: "BearerAuth";
      value: {
        type: TYPE_API_KEY;
        in: IN_HEADER;
        name: "Authorization";
        description: "Bearer <access_token>";
      }
    }
  }
};

enum Provider {
  PROVIDER_UNSPECIFIED = 0;
  GOOGLE = 1;
  YANDEX = 2;
}

service Auth {
  rpc ExchangeCode(ExchangeCodeRequest) returns (ExchangeCodeResponse) {
    option (google.api.http) = {
      post: "/v1/auth/exchange"
      body: "*"
    };

    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Обмен OAuth2 code на access/refresh токены";
      description: "Требуются заголовки: X-Client-Id, X-Client-Secret";
      tags: "Auth";
    };
  }

  rpc UserDetails(UserDetailsRequest) returns (UserDetailsResponse) {
    option (google.api.http) = {
      get: "/v1/auth/user"
    };

    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Получение информации о пользователе";
      description: "Требуется заголовок Authorization: Bearer <token>";
      tags: "Auth";
      security: {
        security_requirement: {
          key: "BearerAuth";
        }
      }
    };
  }

  rpc RefreshToken(RefreshTokenRequest) returns (RefreshTokenResponse) {
    option (google.api.http) = {
      post: "/v1/auth/refresh"
      body: "*"
    };

    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Обновление токенов";
      description: "Требуются заголовки: X-Client-Id, X-Client-Secret";
      tags: "Auth";
    };
  }

  rpc Logout(LogoutRequest) returns (LogoutResponse) {
    option (google.api.http) = {
      post: "/v1/auth/logout"
      body: "*"
    };

    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Выход пользователя";
      description: "Инвалидация refresh токена";
      tags: "Auth";
    };
  }

  rpc RevokeRefreshToken(RevokeRefreshTokenRequest) returns (RevokeRefreshTokenResponse) {
    option (google.api.http) = {
      post: "/v1/auth/revoke"
      body: "*"
    };

    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Принудительная инвалидация refresh токена";
      tags: "Auth";
    };
  }
}

message ExchangeCodeRequest {
  Provider provider = 1;
  string code = 2;
}

message ExchangeCodeResponse {
  string access_token = 1;
  string refresh_token = 2;
}

message UserDetailsRequest {
  string access_token = 1;
}

message UserDetailsResponse {
  int64 user_id = 1;
  string email = 2;
  string name = 3;
}

message RefreshTokenRequest {
  string refresh_token = 1;
}

message RefreshTokenResponse {
  string access_token = 1;
  string refresh_token = 2;
}

message LogoutRequest {
  string refresh_token = 1;
}

message LogoutResponse {}

message RevokeRefreshTokenRequest {
  string refresh_token = 1;
}

message RevokeRefreshTokenResponse {}
